"use strict";(function(){"use strict";const a=document.getElementById("js-watch");if(!a)return;const u=window.SteamDB;let l=null,i=null,d=null;if("BroadcastChannel"in window)try{d=new BroadcastChannel("steamdb-extension"),d.addEventListener("message",t=>{if(!(!t||t.origin!==window.location.origin)&&t.data&&t.data.type==="steamdb:extension-response"){if(!t.data.response||!t.data.response.success)return;if(t.data.request.contentScriptQuery==="RefreshWatchCollections"){l=null;try{window.sessionStorage.removeItem("watch_collections")}catch{}}}})}catch{}const m=()=>{try{const n=window.sessionStorage.getItem("watch_collections");if(n){const s=JSON.parse(n);if(s)return Promise.resolve(s)}}catch{}const t=new FormData;return t.append("action","getlist"),fetch("/api/WatchList/",{method:"POST",body:t,headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}}).then(n=>n.json()).then(n=>{if(!n||!n.success){const o=new Error(n.error||"Something went wrong.");throw o.name="ServerError",o}const s=n.data;try{window.sessionStorage.setItem("watch_collections",JSON.stringify(s))}catch{}return s}).catch(n=>{u.Alert("Failed to load collections: "+n)})},h=()=>{i?.hidePopover()},w=()=>{if(a.classList.contains("watched")){p(!0);return}if(i)return;const t=document.createElement("div");t.className="collection-dropdown";const n=document.createElement("div");n.className="collection-option",n.textContent="Uncategorized",n.addEventListener("click",function(){h(),p(!1)}),t.append(n);const s=document.createElement("div");s.className="collection-option muted",s.textContent="Loading\u2026",t.append(s);const o=document.createElement("div");o.classList.add("collection-dropdown-container"),o.setAttribute("popover","auto"),o.append(t),document.body.append(o),i=o;{const e=a.getBoundingClientRect();t.style.top=`${e.bottom+10}px`;const c=document.documentElement.clientWidth;e.left+200>c?(t.style.right=`${c-e.right}px`,t.style.left="auto"):(t.style.left=`${e.left}px`,t.style.right="auto")}o.addEventListener("toggle",e=>{e.newState!=="open"&&(o.remove(),i=null)}),l.then(e=>{i!==null&&(s.remove(),e&&e.forEach(c=>{const r=document.createElement("div");r.className="collection-option",r.dataset.listId=c.Id.toString(),r.textContent=c.Name,r.addEventListener("click",function(){h(),p(!1,this.dataset.listId)}),t.append(r)}))}),o.showPopover()},p=(t,n)=>{a.classList.add("disabled");const s=new FormData,o={contentScriptQuery:t?"Unwatch":"Watch",watchName:document.querySelector('h1[itemprop="name"]')?.textContent};switch(a.dataset.scope){case"app":{const e=a.dataset.appid;o.appid=parseInt(e,10),s.append("appid",e);break}case"sub":{const e=a.dataset.subid;o.subid=parseInt(e,10),s.append("subid",e);break}case"bundle":{const e=a.dataset.bundleid;o.bundleid=parseInt(e,10),s.append("bundleid",e);break}}!t&&n&&(o.listid=parseInt(n,10),s.append("listid",n)),fetch(t?"/api/Unwatch/":"/api/Watch/",{method:"POST",body:s,headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}}).then(e=>e.json()).then(e=>{if(!e||!e.success){const r=new Error(e.error||"Something went wrong.");throw r.name="ServerError",r}let c=!1;if(d!==null)try{d.postMessage({type:"steamdb:extension-response",request:o,response:{success:!0}}),c=!0}catch{}c||a.classList.toggle("watched",!t)}).catch(e=>{if(u.Alert(`Failed to ${t?"unwatch":"watch"}: ${e}`),e.name!=="ServerError")throw e}).finally(()=>{a.classList.remove("disabled")})};a.addEventListener("click",function(t){t.preventDefault(),!this.classList.contains("disabled")&&(l??=m(),w())})})();
