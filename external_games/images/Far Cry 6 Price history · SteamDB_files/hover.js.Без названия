"use strict";(function(){"use strict";const c=window.SteamDB,Q=!!document.querySelector(".header-user-avatar");let D=Q?300:900;const ce=Q?175:300,p=document.querySelector(".hover_wrapper");if(!p)return;const s=p.querySelector("#js-hover");if(!s||!c)return;const C=new Map;let A=null,f=null,b=null,m=null,H=null,G=!0,x=null,g=null;const h=document.querySelector("#js-screenshots"),J=document.body.dataset.storeAssets,W=new Image;W.fetchPriority="low";let a=null,q=0,v=0,K=!1;c.RequirePageScreenshotViewer(ie,!0),ue(),p.addEventListener("click",ae),s.addEventListener("pointerenter",ve,{passive:!0}),s.addEventListener("pointerleave",pe,{passive:!0}),document.body.addEventListener("touchstart",de,{passive:!0}),c.BindHover=e=>ne(e.querySelectorAll(".app")),c.HideHoverIfAny=u,c.OnExtensionUserdataLoaded(()=>{G=!1});function ae(e){e.target instanceof Element&&e.target.classList.contains("hover_mobile")&&ee(s)}let y=null,w=null,d=null,k=!1,O=!1,z=0;function de(e){if(e.touches.length!==1||!(e.target instanceof HTMLElement))return;const t=e.target.closest(".app, #js-hover");if(t){if(k=t.id==="js-hover",O=!1,k){if(s.scrollTop>0)return;z=Date.now(),t.classList.add("hover_dragging")}else{const n=te(t,0);if(n!==null&&n.scrollLeft!==0)return}d=t,y=w=e.touches.item(0),document.body.addEventListener("touchmove",Z,{passive:!0}),document.body.addEventListener("touchend",_,{passive:!0})}}function Z(e){const t=e.touches.item(0),n=t.screenX-y.screenX,o=t.screenY-y.screenY;if(k){if(w=t,O||s.scrollTop>0){O=!0,y=t;return}d.style.transform=`translate3d(0, ${Math.max(0,o)}px, 0)`;return}if(t.screenX<w.screenX||Math.abs(o/n)>=.3){d=null,_();return}w=t}function _(){if(document.body.removeEventListener("touchmove",Z),document.body.removeEventListener("touchend",_),d!==null){if(k){d.classList.remove("hover_dragging");const e=w.screenY-y.screenY,t=s.offsetHeight,n=Date.now()-z,o=e/n;e>t/3||o>.5?ee(d):d.style.transform="";return}if(w.screenX-y.screenX>100){const e=+d.dataset.appid,t=C.get(e);if(p.classList.add("hover_mobile"),document.documentElement.classList.add("js-hover-shown"),"CloseWatcher"in window&&(x=new window.CloseWatcher,x.addEventListener("close",()=>u(!0))),t){s.appendChild(t),I(t,null);return}re(e,null)}d=null}}function ee(e){if(e.hidden){u(!0);return}p.classList.add("hover_hiding"),e.addEventListener("transitionend",()=>u(),{once:!0}),e.style.transform=`translate3d(0, ${Math.max(0,e.offsetHeight)}px, 0)`}function te(e,t){return e===null||t>8?null:e.scrollWidth>e.clientWidth?e:te(e.parentElement,t+1)}function ue(){const e=typeof $=="function"&&typeof $.fn=="object"&&typeof $.fn.dataTable=="function";let t=e?[]:document.querySelectorAll(".app");e&&$($.fn.dataTable.tables()).each(function(){const n=$(this).DataTable().table();t=Array.from(n.rows(".app").nodes()),$(this).on("draw.dt",()=>u())}),ne(t)}function ne(e){for(const t of e)t.addEventListener("pointerenter",oe,{passive:!0}),t.addEventListener("pointerleave",fe,{passive:!0})}function oe(e){const t=e.target;if(e.pointerType!=="mouse"||!(t instanceof HTMLElement)||window.matchMedia("(max-width: 979px)").matches)return;if(f){b=e;return}const n=+t.dataset.appid,o=C.get(n);if(o){s.appendChild(o),I(o,t);return}u(),A=setTimeout(()=>{re(n,t)},D)}function re(e,t){if(m=new AbortController,fetch(`/api/RenderAppHover/?appid=${e}`,{headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"},signal:m.signal}).then(n=>{if(!n.ok){n.status>=400&&n.status!==404&&(D=5e3);const o=new Error(`HTTP ${n.status}`);throw o.name="ServerError",o}return n.text()}).then(n=>{m=null,D=ce,s.insertAdjacentHTML("beforeend",n);const o=s.lastElementChild;if(o instanceof HTMLElement){C.set(e,o),me(e,o);const r=o.querySelector(".js-open-screenshot-viewer");if(r&&r.dataset.screenshots){const i=r.dataset.screenshots.split(","),l=o.querySelector(".hover_title").textContent;ie(+r.dataset.appid,l,r,i)}I(o,t)}}).catch(n=>{if(n.name!=="AbortError"&&(u(!0),n.name!=="ServerError"))throw n}),!K){K=!0;const n=document.createElement("link");n.rel="preconnect",n.href=document.body.dataset.videoCdn,document.head.append(n)}}function u(e=!1){if(b=null,A&&(clearTimeout(A),A=null),f&&(clearTimeout(f),f=null),m&&(m.abort(),m=null),x&&(x.destroy(),x=null),H){s.scrollTop=0,s.hidden=!0,s.style.transform="";const t=H.querySelector("video");t&&t.remove(),H.remove(),H=null,e=!0}e&&(p.classList.remove("hover_mobile","hover_hiding"),document.documentElement.classList.remove("js-hover-shown"))}function fe(e){e.pointerType==="mouse"&&(b=null,!f&&(e.relatedTarget instanceof Element&&s.contains(e.relatedTarget)||(f=setTimeout(he,100))))}function he(){const e=b;u(),e&&oe(e)}function ve(){clearTimeout(f),f=null,b=null}function pe(e){e.pointerType==="mouse"&&u()}function I(e,t){H=e;const n=e.querySelector(".hover_video"),o=n?.dataset.microtrailer;if(o){const L=document.createElement("video");L.autoplay=!0,L.muted=!0,L.loop=!0,L.playsInline=!0;const Se=document.body.dataset.videoCdn,le=JSON.parse(o);for(const[Ee,Le]of Object.entries(le.video)){const N=document.createElement("source");N.type=Ee,N.src=`${Se}store_trailers/${Le}?t=${le.time}`,L.append(N)}n.appendChild(L)}if(s.hidden=!1,t===null)return;const r=t.getBoundingClientRect(),i=document.documentElement.scrollTop,l=r.top+i,ge=r.bottom+i,X=r.left+document.documentElement.scrollLeft,ye=document.documentElement.clientWidth,F=document.documentElement.clientHeight,Y=s.offsetWidth,T=s.offsetHeight,we=ye-(X+r.width+Y),V=X-Y;let E=0;V<0&&we<0?(s.style.left=r.right-Y+"px",l+T>F+i&&l-T>=i?E=l-T:E=ge):(V<0?s.style.left=X+r.width+"px":s.style.left=V+"px",l+T>F+i?E=F+i-T:E=l),E<1?s.style.top="0":s.style.top=E+"px"}function S(e){v+=e,v<0?v=a.length-1:v%=a.length;let t=a[v];if(t.startsWith("https://")||(t=`${J}apps/${q}/${t}`),h.querySelector(".screenshot-contain").style.backgroundImage=`url(${encodeURI(t)})`,h.querySelector(".screenshot-index").textContent=`${v+1} of ${a.length}`,h.querySelector(".screenshot-open").href=t,a.length>1){e===0&&(e=1);let n=v+e;n<0?n=a.length-1:n%=a.length,t=a[n],t.startsWith("https://")||(t=`${J}apps/${q}/${t}`),W.src=t}}function se(e){e.key==="ArrowLeft"?(e.preventDefault(),S(-1)):e.key==="ArrowRight"||e.key===" "?(e.preventDefault(),S(1)):e.key==="Escape"&&g===null&&(e.preventDefault(),M())}function M(){document.documentElement.classList.remove("js-screenshots-shown"),document.removeEventListener("keydown",se),a=null,W.src="/static/p.gif",g&&(g.destroy(),g=null)}h.querySelector(".screenshot-prev").addEventListener("click",e=>{e.preventDefault(),S(-1)}),h.querySelector(".screenshot-next").addEventListener("click",e=>{e.preventDefault(),S(1)}),h.querySelector(".screenshot-close").addEventListener("click",e=>{e.preventDefault(),M()}),h.querySelector(".screenshot-contain").addEventListener("click",e=>{e.preventDefault(),S(e.pageX/document.documentElement.clientWidth>=.5?1:-1)});function ie(e,t,n,o){const r=i=>{const l=h.querySelector(".screenshot-name");l.textContent=`SteamDB \u2014 ${t}`,l.href=`/app/${e}/`,v=i,q=e,a=o,S(0),document.documentElement.classList.add("js-screenshots-shown"),document.addEventListener("keydown",se),"CloseWatcher"in window&&(g=new window.CloseWatcher,g.addEventListener("close",M))};return n&&n.addEventListener("click",i=>{i.preventDefault(),r(0)}),{open:r}}function me(e,t){if(G)return;const n=t.querySelector(".hover_wishlist"),o=t.querySelector(".hover_follow"),r=t.querySelector(".hover_ignore"),i=t.querySelector(".hover_owned");c.OwnedApps.has(e)?i.hidden=!1:(c.FamilySharedApps.has(e)&&(i.textContent="In Family Library",i.classList.add("infamily"),i.hidden=!1),n&&(c.WishedApps.has(e)&&R(n,!0),n.hidden=!1,n.addEventListener("click",l=>{l.preventDefault(),j(n),B(e,c.WishedApps.has(e)?"StoreWishlistRemove":"StoreWishlistAdd")}))),o&&(c.FollowedApps.has(e)&&P(o,!0),o.hidden=!1,o.addEventListener("click",l=>{l.preventDefault(),j(o),B(e,c.FollowedApps.has(e)?"StoreUnfollow":"StoreFollow")})),r&&(c.IgnoredApps.has(e)&&U(r,!0),r.hidden=!1,r.addEventListener("click",l=>{l.preventDefault(),j(r),B(e,c.IgnoredApps.has(e)?"StoreUnignore":"StoreIgnore")}))}function j(e){e.innerHTML='<span class="loader"></span>'}function B(e,t){window.postMessage({type:"steamdb:extension-query",contentScriptQuery:t,appid:e},window.location.origin)}function R(e,t){e&&(e.classList.toggle("wished",t),e.textContent=t?"On Wishlist":"Wishlist")}function P(e,t){e&&(e.classList.toggle("followed",t),e.textContent=t?"Unfollow":"Follow")}function U(e,t){e&&(e.classList.toggle("ignored",t),e.textContent=t?"Unignore":"Ignore")}if("BroadcastChannel"in window)try{new BroadcastChannel("steamdb-extension").addEventListener("message",t=>{if(!(!t||t.origin!==window.location.origin)&&t.data&&t.data.type==="steamdb:extension-response"){if(!t.data.response||!t.data.response.success||!t.data.request.appid)return;const n=C.get(t.data.request.appid);if(!n)return;const o=n.querySelector(".hover_wishlist"),r=n.querySelector(".hover_follow"),i=n.querySelector(".hover_ignore");switch(t.data.request.contentScriptQuery){case"StoreWishlistAdd":R(o,!0);break;case"StoreWishlistRemove":R(o,!1);break;case"StoreFollow":P(r,!0);break;case"StoreUnfollow":P(r,!1);break;case"StoreIgnore":U(i,!0);break;case"StoreUnignore":U(i,!1);break}}})}catch{}})();
