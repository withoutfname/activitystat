"use strict";(function(){"use strict";const u=window.SteamDB,k=navigator.webdriver||/bot|spider/i.test(navigator.userAgent);let c=0,h=0;const f=document.querySelector(".history-container"),r=document.querySelector("#js-history-load"),S=document.querySelector(".history-filters-container"),m=document.querySelector("#js-filter-history-load"),d=document.querySelector("#js-filter-history-key"),a=document.querySelector("#js-filter-history-date"),E=document.querySelector("#js-history-loading"),v=new window.diff_match_patch,w=function(e){e.forEach(t=>{const n=v.diff_main(t.querySelector("del").textContent,t.querySelector("ins").textContent);v.diff_cleanupSemantic(n),v.diff_cleanupEfficiency(n),t.replaceChildren(v.diff_generateHtmlFragment(n))})};if(m&&m.addEventListener("click",function(){this.disabled=!0,this.textContent="Loading\u2026";let e;switch(r.dataset.scope){case"app":e=`appid=${r.dataset.appid}`;break;case"sub":e=`subid=${r.dataset.subid}`;break}fetch(`/api/GetHistoryFilters/?${e}`,{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}}).then(t=>{if(!t.ok){const n=new Error(`HTTP ${t.status}`);throw n.name="ServerError",n}return t.json()}).then(t=>{if(m.hidden=!0,t&&t.success){for(const n of t.data){const i=document.createElement("option");i.value=n.Key.toString(),i.textContent=n.Name,d.appendChild(i),c===n.Key&&(i.selected=!0)}d.hidden=!1}}).catch(t=>{throw m.textContent="Failed to load history filters",u.Alert("Failed to load history filters: "+t),t})},{once:!0}),d){d.addEventListener("change",function(){h=0,c=Number.parseInt(this.value,10),f.replaceChildren(),p();const t=new URLSearchParams(location.search);c>0?t.set("filterkey",c.toString()):t.delete("filterkey"),history.replaceState(null,null,Array.from(t).length?`${location.pathname}?${t}`:location.pathname)});const e=new URLSearchParams(location.search);if(e.has("filterkey"))if(c=parseInt(e.get("filterkey"),10)||0,m)m.click();else{const t=d.querySelector(`option[value="${c}"]`);t&&(t.selected=!0)}}a&&(a.max=new Date().toISOString().substring(0,10),document.querySelector("#js-filter-history-date-load").addEventListener("click",e=>{e.preventDefault(),a.checkValidity()&&(h=0,f.replaceChildren(),p())}),document.querySelector("#js-filter-history-date-reset").addEventListener("click",e=>{e.preventDefault(),h=0,a.value=null,f.replaceChildren(),p()}),document.querySelector("#js-filter-history-date-toggle").addEventListener("click",e=>{e.preventDefault();const t=document.querySelector(".history-filter-date");t.hidden=!t.hidden,t.hidden?a.value=null:a.focus()})),r&&(r.addEventListener("click",()=>{r.disabled||p()}),document.getElementById("js-history-back").addEventListener("click",function(e){e.preventDefault(),history.replaceState(null,null,this.href),h=0,delete r.dataset.changeid,S&&(S.hidden=!1),document.getElementById("js-history-header-single").hidden=!0;const t=document.getElementById("js-history-header-all");t.hidden=!1,t.scrollIntoView({behavior:"smooth",block:"nearest"}),f.replaceChildren(),p()}));function L(e){if(document.body.classList.contains("page-history")||document.body.classList.contains("page-changelist"))return;e.preventDefault(),document.getElementById("js-history-back").href=location.href,history.replaceState(null,null,this.href);const t=new URL(this.href),n=new URLSearchParams(t.search);r.dataset.changeid=n.get("changeid"),h=0,S&&(S.hidden=!0),document.getElementById("js-history-header-all").hidden=!0;const i=document.getElementById("js-history-header-single");i.querySelector("b").textContent=n.get("changeid"),i.hidden=!1,i.scrollIntoView({behavior:"smooth",block:"nearest"}),f.replaceChildren(),p()}function p(){d&&(d.disabled=!0),a&&(a.disabled=!0),E.hidden=!1,r.disabled=!0,r.classList.add("app-history-loading"),r.parentElement.hidden=!1;const e=new URLSearchParams;e.append("lastentry",h.toString()),r.dataset.changeid?e.append("changeid",r.dataset.changeid):(c>0&&e.append("key",c.toString()),h===0&&a&&a.value&&e.append("before",a.value));const t=(i,b,o)=>{if(r.disabled=!1,r.classList.remove("app-history-loading"),d&&(d.disabled=!1),a&&(a.disabled=!1),b===0){r.parentElement.hidden=!0;return}const s=document.createElement("div");s.innerHTML=i;const g=s.querySelector(".panel-history:first-child");if(g){const y=f.querySelector('.panel-history[data-changeid="'+g.dataset.changeid+'"]');y&&(y.querySelector(".app-history").append(...g.querySelector(".app-history").childNodes),g.remove())}if(w(s.querySelectorAll(".diff")),u.EnhanceLazyLoadedApps&&(u.EnhanceLazyLoadedApps(s),u.EnhanceLazyLoadedPackages(s)),"BindImageHover"in u){const y=s.querySelectorAll(".image-hover");y.length>0&&u.BindImageHover(y)}const l=s.querySelectorAll(".app-history-permalink");for(const y of l)y.addEventListener("click",L);f.append(...s.childNodes),E.hidden=!0,o?b===-1?(r.disabled=!0,r.hidden=!0,document.getElementById("js-history-signin").hidden=!1):h=b:r.parentElement.hidden=!0},n=(i,b)=>{fetch(`/api/${i}/?${b.toString()}`,{headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"}}).then(o=>{if(!o.ok){const l=new Error(`HTTP ${o.status}`);throw l.name="ServerError",l}const s=o.headers.get("X-SteamDB-History-LastChangeID"),g=o.headers.get("X-SteamDB-History-More");if(s===null){const l=new Error("No history was returned.");throw l.name="ServerError",l}o.text().then(l=>t(l,parseInt(s,10),g==="yes"))}).catch(o=>{if(r.parentElement.hidden=!0,u.Alert("Failed to load history: "+o),o.name!=="ServerError")throw o})};switch(r.dataset.scope){case"app":e.append("appid",r.dataset.appid),n("GetAppHistory",e);break;case"sub":e.append("subid",r.dataset.subid),n("GetSubHistory",e);break;case"depot":e.append("depotid",r.dataset.depotid),n("GetDepotHistory",e);break;case"bundle":e.append("bundleid",r.dataset.bundleid),n("GetBundleHistory",e);break;case"appsub":{e.append("appid",r.dataset.appid),n("GetAppHistory",e),e.delete("appid"),e.append("subid",r.dataset.subid),n("GetSubHistory",e);return}default:throw new Error("Unknown history scope")}}if(r&&!k){let e=0;const t=new window.IntersectionObserver(n=>{n.forEach(i=>{i.isIntersecting&&(e++>2&&t.unobserve(r),r.disabled||p())})},{root:null});t.observe(r)}})();
